<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Worker åŠŸèƒ½æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      max-width: 1000px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button {
      padding: 0.75rem 1.5rem;
      margin: 0.5rem;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 1rem;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 1rem;
      border-radius: 4px;
      max-height: 500px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      margin-top: 1rem;
    }
    .log-item {
      margin-bottom: 0.25rem;
      padding: 0.25rem;
    }
    .log-item.error { color: #f48771; }
    .log-item.success { color: #89d185; }
    .log-item.info { color: #569cd6; }
    .log-item.warn { color: #dcdcaa; }
    .status {
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª Worker åŠŸèƒ½æµ‹è¯•</h1>
    
    <div>
      <button onclick="test1()">æµ‹è¯• 1: Worker URL è§£æ</button>
      <button onclick="test2()">æµ‹è¯• 2: Worker åˆ›å»º</button>
      <button onclick="test3()">æµ‹è¯• 3: File å¯¹è±¡ä¼ é€’</button>
      <button onclick="test4()">æµ‹è¯• 4: å®Œæ•´åˆ†ç‰‡æµç¨‹</button>
      <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div id="status"></div>
    <div id="log" class="log"></div>
  </div>

  <script type="module">
    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log')
      const time = new Date().toLocaleTimeString()
      const item = document.createElement('div')
      item.className = `log-item ${type}`
      item.textContent = `[${time}] ${message}`
      logDiv.appendChild(item)
      logDiv.scrollTop = logDiv.scrollHeight
      console.log(`[${type.toUpperCase()}]`, message)
    }

    function setStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status')
      statusDiv.className = `status ${type}`
      statusDiv.textContent = message
    }

    // åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    function createTestFile(sizeMB = 5) {
      const size = sizeMB * 1024 * 1024
      const content = new Uint8Array(size)
      for (let i = 0; i < size; i++) {
        content[i] = i % 256
      }
      const blob = new Blob([content], { type: 'application/octet-stream' })
      return new File([blob], `test-${sizeMB}mb.bin`, {
        type: 'application/octet-stream',
        lastModified: Date.now(),
      })
    }

    // æµ‹è¯• 1: Worker URL è§£æ
    window.test1 = async function() {
      log('=== æµ‹è¯• 1: Worker URL è§£æ ===', 'info')
      try {
        const { getWorkerUrl } = await import('./src/utils/workerUrl.ts')
        const url = getWorkerUrl('work.js')
        log(`âœ… Worker URL: ${url.href}`, 'success')
        log(`   è·¯å¾„: ${url.pathname}`, 'info')
        log(`   åè®®: ${url.protocol}`, 'info')
        setStatus(`Worker URL: ${url.href}`, 'success')
      } catch (error) {
        log(`âŒ å¤±è´¥: ${error.message}`, 'error')
        log(`   å †æ ˆ: ${error.stack}`, 'error')
        setStatus(`å¤±è´¥: ${error.message}`, 'error')
      }
    }

    // æµ‹è¯• 2: Worker åˆ›å»º
    window.test2 = async function() {
      log('=== æµ‹è¯• 2: Worker åˆ›å»º ===', 'info')
      try {
        const { createWorker } = await import('./src/utils/workerUrl.ts')
        
        log('åˆ›å»º Worker...', 'info')
        const worker = createWorker('work.js')
        log('âœ… Worker åˆ›å»ºæˆåŠŸ', 'success')

        let messageReceived = false

        worker.onmessage = (e) => {
          messageReceived = true
          log(`âœ… æ”¶åˆ° Worker æ¶ˆæ¯: ${JSON.stringify(e.data)}`, 'success')
          worker.terminate()
          setStatus('Worker åˆ›å»ºå’Œé€šä¿¡æˆåŠŸ', 'success')
        }

        worker.onerror = (error) => {
          log(`âŒ Worker é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
          log(`   æ–‡ä»¶å: ${error.filename || 'æœªçŸ¥'}`, 'error')
          log(`   è¡Œå·: ${error.lineno || 'æœªçŸ¥'}`, 'error')
          if (error.error) {
            log(`   é”™è¯¯å¯¹è±¡: ${JSON.stringify(error.error)}`, 'error')
          }
          setStatus(`Worker é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
        }

        // ç­‰å¾… Worker åŠ è½½
        await new Promise(resolve => setTimeout(resolve, 2000))

        if (!messageReceived) {
          log('âš ï¸ æœªæ”¶åˆ° Worker å“åº”ï¼ˆå¯èƒ½ Worker ä»åœ¨åŠ è½½ï¼‰', 'warn')
        }

        // å‘é€æµ‹è¯•æ¶ˆæ¯
        log('å‘é€æµ‹è¯•æ¶ˆæ¯åˆ° Worker...', 'info')
        worker.postMessage({ test: 'hello' })

        setTimeout(() => {
          if (!messageReceived) {
            log('âš ï¸ 5ç§’å†…æœªæ”¶åˆ°å“åº”ï¼Œç»ˆæ­¢ Worker', 'warn')
            worker.terminate()
          }
        }, 5000)
      } catch (error) {
        log(`âŒ å¤±è´¥: ${error.message}`, 'error')
        log(`   å †æ ˆ: ${error.stack}`, 'error')
        setStatus(`å¤±è´¥: ${error.message}`, 'error')
      }
    }

    // æµ‹è¯• 3: File å¯¹è±¡ä¼ é€’
    window.test3 = async function() {
      log('=== æµ‹è¯• 3: File å¯¹è±¡ä¼ é€’ ===', 'info')
      try {
        const { createWorker } = await import('./src/utils/workerUrl.ts')
        
        const file = createTestFile(1) // 1MB
        log(`åˆ›å»ºæµ‹è¯•æ–‡ä»¶: ${file.name}, å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`, 'success')

        const worker = createWorker('work.js')
        log('âœ… Worker åˆ›å»ºæˆåŠŸ', 'success')

        let messageReceived = false

        worker.onmessage = (e) => {
          messageReceived = true
          if (e.data && typeof e.data === 'object' && 'success' in e.data) {
            if (e.data.success) {
              log(`âœ… Worker å¤„ç†æˆåŠŸ: ${e.data.data?.length || 0} ä¸ªåˆ†ç‰‡`, 'success')
              setStatus('File å¯¹è±¡ä¼ é€’å’Œå¤„ç†æˆåŠŸ', 'success')
            } else {
              log(`âŒ Worker å¤„ç†å¤±è´¥: ${e.data.error?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
              setStatus(`å¤„ç†å¤±è´¥: ${e.data.error?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
            }
          } else {
            log(`âœ… æ”¶åˆ° Worker æ¶ˆæ¯: ${JSON.stringify(e.data)}`, 'success')
            setStatus('æ”¶åˆ° Worker æ¶ˆæ¯', 'success')
          }
          worker.terminate()
        }

        worker.onerror = (error) => {
          log(`âŒ Worker é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
          log(`   æ–‡ä»¶å: ${error.filename || 'æœªçŸ¥'}`, 'error')
          log(`   è¡Œå·: ${error.lineno || 'æœªçŸ¥'}`, 'error')
          log(`   åˆ—å·: ${error.colno || 'æœªçŸ¥'}`, 'error')
          if (error.error) {
            log(`   é”™è¯¯å¯¹è±¡: ${JSON.stringify(error.error)}`, 'error')
          }
          setStatus(`Worker é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error')
        }

        // ç­‰å¾… Worker åŠ è½½
        await new Promise(resolve => setTimeout(resolve, 2000))

        log(`å°è¯•å‘é€ File å¯¹è±¡åˆ° Worker...`, 'info')
        log(`  æ–‡ä»¶å: ${file.name}`, 'info')
        log(`  æ–‡ä»¶å¤§å°: ${file.size} å­—èŠ‚`, 'info')
        log(`  æ–‡ä»¶ç±»å‹: ${file.type}`, 'info')

        try {
          worker.postMessage({
            file: file,
            CHUNK_SIZE: 256 * 1024, // 256KB
            startIndex: 0,
            endIndex: 1,
          })
          log('âœ… File å¯¹è±¡å‘é€æˆåŠŸ', 'success')

          setTimeout(() => {
            if (!messageReceived) {
              log('âš ï¸ 10ç§’å†…æœªæ”¶åˆ°å“åº”', 'warn')
              worker.terminate()
            }
          }, 10000)
        } catch (postError) {
          log(`âŒ å‘é€å¤±è´¥: ${postError.message}`, 'error')
          log(`   é”™è¯¯ç±»å‹: ${postError.name}`, 'error')
          log(`   å †æ ˆ: ${postError.stack}`, 'error')
          setStatus(`å‘é€å¤±è´¥: ${postError.message}`, 'error')
          worker.terminate()
        }
      } catch (error) {
        log(`âŒ å¤±è´¥: ${error.message}`, 'error')
        log(`   å †æ ˆ: ${error.stack}`, 'error')
        setStatus(`å¤±è´¥: ${error.message}`, 'error')
      }
    }

    // æµ‹è¯• 4: å®Œæ•´åˆ†ç‰‡æµç¨‹
    window.test4 = async function() {
      log('=== æµ‹è¯• 4: å®Œæ•´åˆ†ç‰‡æµç¨‹ ===', 'info')
      try {
        const { fragmentFile } = await import('./src/fragmentFile.ts')
        
        const file = createTestFile(2) // 2MB
        log(`åˆ›å»ºæµ‹è¯•æ–‡ä»¶: ${file.name}, å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`, 'success')

        const startTime = Date.now()
        log('å¼€å§‹åˆ†ç‰‡å¤„ç†...', 'info')

        const chunks = await fragmentFile(
          file,
          512 * 1024, // 512KB chunks
          (error) => {
            log(`âŒ é”™è¯¯å›è°ƒ: ${error.message}`, 'error')
            log(`   é”™è¯¯ç±»å‹: ${error.type}`, 'error')
            if (error.originalError) {
              log(`   åŸå§‹é”™è¯¯: ${error.originalError.message}`, 'error')
            }
          },
          (progress) => {
            log(`è¿›åº¦: ${progress.percentage}% (${progress.processedChunks || 0}/${progress.totalChunks || 0} åˆ†ç‰‡, ${(progress.loaded / 1024 / 1024).toFixed(2)} MB / ${(progress.total / 1024 / 1024).toFixed(2)} MB)`, 'info')
          }
        )

        const endTime = Date.now()
        const duration = ((endTime - startTime) / 1000).toFixed(2)

        log(`âœ… åˆ†ç‰‡å®Œæˆ!`, 'success')
        log(`   æ€»åˆ†ç‰‡æ•°: ${chunks.length}`, 'success')
        log(`   å¤„ç†æ—¶é—´: ${duration} ç§’`, 'success')
        log(`   ç¬¬ä¸€ä¸ªåˆ†ç‰‡å“ˆå¸Œ: ${chunks[0]?.hash.substring(0, 16)}...`, 'success')
        log(`   æœ€åä¸€ä¸ªåˆ†ç‰‡ç´¢å¼•: ${chunks[chunks.length - 1]?.index}`, 'success')
        
        setStatus(`åˆ†ç‰‡å®Œæˆ: ${chunks.length} ä¸ªåˆ†ç‰‡ï¼Œè€—æ—¶ ${duration} ç§’`, 'success')
      } catch (error) {
        log(`âŒ åˆ†ç‰‡å¤±è´¥: ${error.message}`, 'error')
        log(`   é”™è¯¯ç±»å‹: ${error.name}`, 'error')
        log(`   å †æ ˆ: ${error.stack}`, 'error')
        setStatus(`åˆ†ç‰‡å¤±è´¥: ${error.message}`, 'error')
      }
    }

    window.clearLog = function() {
      document.getElementById('log').innerHTML = ''
      document.getElementById('status').textContent = ''
    }

    log('âœ… æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success')
    log('ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info')
  </script>
</body>
</html>
